using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Data;

namespace MOE.Common.Business
{
    public class DetectorCollection


    {

        public List<MOE.Common.Business.Detector> NBDetectors { get; set; }
        public List<MOE.Common.Business.Detector> SBDetectors { get; set; }
        public List<MOE.Common.Business.Detector> EBDetectors { get; set; }
        public List<MOE.Common.Business.Detector> WBDetectors { get; set; }
        public List<MOE.Common.Business.Detector> NBBikeDetectors { get; set; }
        public List<MOE.Common.Business.Detector> SBBikeDetectors { get; set; }
        public List<MOE.Common.Business.Detector> EBBikeDetectors { get; set; }
        public List<MOE.Common.Business.Detector> WBBikeDetectors { get; set; }
        public List<MOE.Common.Business.Detector> NBPedDetectors { get; set; }
        public List<MOE.Common.Business.Detector> SBPedDetectors { get; set; }
        public List<MOE.Common.Business.Detector> EBPedDetectors { get; set; }
        public List<MOE.Common.Business.Detector> WBPedDetectors { get; set; }
        public List<MOE.Common.Business.Detector> PedDetectors { get; set; }


        




        private List<MOE.Common.Business.Detector> NBleftDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> NBLeftDetectors
        {
            get { return NBleftDetectors; }
        }

        private List<MOE.Common.Business.Detector> SBleftDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> SBLeftDetectors
        {
            get { return SBleftDetectors; }
        }

        private List<MOE.Common.Business.Detector> EBleftDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> EBLeftDetectors
        {
            get { return EBleftDetectors; }
        }

        private List<MOE.Common.Business.Detector> WBleftDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> WBLeftDetectors
        {
            get { return WBleftDetectors; }
        }

        private List<MOE.Common.Business.Detector> NBrightDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> NBRightDetectors
        {
            get { return NBrightDetectors; }
        }

        private List<MOE.Common.Business.Detector> SBrightDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> SBRightDetectors
        {
            get { return SBrightDetectors; }
        }

        private List<MOE.Common.Business.Detector> EBrightDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> EBRightDetectors
        {
            get { return EBrightDetectors; }
        }

        private List<MOE.Common.Business.Detector> WBrightDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> WBRightDetectors
        {
            get { return WBrightDetectors; }
        }

        private List<MOE.Common.Business.Detector> NBthruDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> NBThruDetectors
        {
            get { return NBthruDetectors; }
        }

        private List<MOE.Common.Business.Detector> SBthruDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> SBThruDetectors
        {
            get { return SBthruDetectors; }
        }

        private List<MOE.Common.Business.Detector> EBthruDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> EBThruDetectors
        {
            get { return EBthruDetectors; }
        }

        private List<MOE.Common.Business.Detector> WBthruDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> WBThruDetectors
        {
            get { return WBthruDetectors; }
        }

        private List<MOE.Common.Business.Detector> NBexitDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> NBExitDetectors
        {
            get { return NBexitDetectors; }
        }

        private List<MOE.Common.Business.Detector> SBexitDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> SBExitDetectors
        {
            get { return SBexitDetectors; }
        }

        private List<MOE.Common.Business.Detector> EBexitDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> EBExitDetectors
        {
            get { return EBexitDetectors; }
        }

        private List<MOE.Common.Business.Detector> WBexitDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> WBExitDetectors
        {
            get { return WBexitDetectors; }
        }

        private List<MOE.Common.Business.Detector> NBLTbikeDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> NBLTBikeDetectors
        {
            get { return NBLTbikeDetectors; }
        }

        private List<MOE.Common.Business.Detector> NBRTbikeDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> NBRTBikeDetectors
        {
            get { return NBRTbikeDetectors; }
        }

        private List<MOE.Common.Business.Detector> NBThrubikeDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> NBThruBikeDetectors
        {
            get { return NBThrubikeDetectors; }
        }

        private List<MOE.Common.Business.Detector> SBLTbikeDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> SBLTBikeDetectors
        {
            get { return SBLTbikeDetectors; }
        }

        private List<MOE.Common.Business.Detector> SBRTbikeDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> SBRTBikeDetectors
        {
            get { return SBRTbikeDetectors; }
        }

        private List<MOE.Common.Business.Detector> SBThrubikeDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> SBThruBikeDetectors
        {
            get { return SBThrubikeDetectors; }
        }

        private List<MOE.Common.Business.Detector> EBLTbikeDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> EBLTBikeDetectors
        {
            get { return EBLTbikeDetectors; }
        }

        private List<MOE.Common.Business.Detector> EBRTbikeDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> EBRTBikeDetectors
        {
            get { return EBRTbikeDetectors; }
        }

        private List<MOE.Common.Business.Detector> EBThrubikeDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> EBThruBikeDetectors
        {
            get { return EBThrubikeDetectors; }
        }

        private List<MOE.Common.Business.Detector> WBLTbikeDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> WBLTBikeDetectors
        {
            get { return WBLTbikeDetectors; }
        }

        private List<MOE.Common.Business.Detector> WBRTbikeDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> WBRTBikeDetectors
        {
            get { return WBRTbikeDetectors; }
        }

        private List<MOE.Common.Business.Detector> WBThrubikeDetectors = new List<Detector>();
        public List<MOE.Common.Business.Detector> WBThruBikeDetectors
        {
            get { return WBThrubikeDetectors; }
        }

        private string _signalId;
        public string SignalId
        {
            get { return _signalId; }
        }

        public List<MOE.Common.Business.Detector> Items = new List<Detector>();

        /// <summary>
        /// Default constructor for the DetectorCollection used in the Turning Movement Counts charts
        /// </summary>
        /// <param name="signalid"></param>
        /// <param name="startdate"></param>
        /// <param name="enddate"></param>
        /// <param name="binsize"></param>
        public DetectorCollection(string signalID, DateTime startdate, DateTime enddate, int binsize)
        {

            _signalId = signalID;
            MOE.Common.Models.Repositories.ISignalsRepository repository =
                MOE.Common.Models.Repositories.SignalsRepositoryFactory.Create();
            var signal = repository.GetSignalBySignalID(signalID); 
            var TMCDT = signal.GetDetectorsForSignalThatSupportAMetric(5);
            foreach (MOE.Common.Models.Detector detector in TMCDT)
            {
                MOE.Common.Business.Detector Detector = new Detector(detector, startdate, enddate, binsize);
                Items.Add(Detector);
            }
            SortDetectors();
        }


        /// <summary>
        /// Alternate Constructor for PCD type data.
        /// </summary>
        /// <param name="signalid"></param>
        /// <param name="approach"></param>
        public DetectorCollection(string signalId, string approach)
        {
            _signalId = signalId;
            MOE.Common.Models.Repositories.ISignalsRepository repository =
                MOE.Common.Models.Repositories.SignalsRepositoryFactory.Create();
            var signal = repository.GetSignalBySignalID(signalId);
            var TMCDT = signal.GetDetectorsForSignalThatSupportAMetric(6);
            foreach (MOE.Common.Models.Detector row in TMCDT)
            {
                MOE.Common.Business.Detector Detector = new Detector(row.DetectorID.ToString(), _signalId, row.DetChannel, 
                    row.Approach, row.Approach.DirectionType.Description);
                Items.Add(Detector);
            }
        }

        public ControllerEventLogs CombineDetectorData(DateTime startDate, DateTime endDate, double offset, string signalId)
        {
            ControllerEventLogs detectortable = new ControllerEventLogs(signalId, startDate, endDate);
            List<ControllerEventLogs> Tables = new List<ControllerEventLogs>();
            foreach (MOE.Common.Business.Detector Detector in Items)
            {
                ControllerEventLogs TEMPdetectortable = new ControllerEventLogs(signalId, startDate, endDate, new List<int>() { 82 });
                
                Tables.Add(TEMPdetectortable);
            }

            foreach (ControllerEventLogs Table in Tables)
            {
                detectortable.MergeEvents(Table);
            }


            return detectortable;
        }

        public ControllerEventLogs CombineDetectorDataByApproachAndType(DateTime startDate, DateTime endDate, string signalId, string direction, bool Has_PCD, bool Has_TMC)
        {
            MOE.Common.Models.Repositories.ISignalsRepository repository =
                   MOE.Common.Models.Repositories.SignalsRepositoryFactory.Create();
            var signal = repository.GetSignalBySignalID(signalId);
            MOE.Common.Models.Repositories.IDetectorRepository gr = MOE.Common.Models.Repositories.DetectorRepositoryFactory.Create();


            List<MOE.Common.Models.Detector> allDets = new List<Models.Detector>();

            if(Has_TMC)
            {
            allDets.AddRange(signal.GetDetectorsForSignalThatSupportAMetric(5));
            }

            if(Has_PCD)
            {
            allDets.AddRange(signal.GetDetectorsForSignalThatSupportAMetric(6));
            }

             var detectors = (from s in allDets                             
                              where s.Approach.DirectionType.Description == direction                             
                             select s
                          );

            List<ControllerEventLogs> eventsList = new List<ControllerEventLogs>();

            ControllerEventLogs MergedEvents = new ControllerEventLogs(signalId, startDate, endDate);

            foreach (Models.Detector detector in detectors)
            {
                List<int> li = new List<int> { 82 };
                ControllerEventLogs cs = new ControllerEventLogs(signalId, startDate, endDate, detector.DetChannel, li);
                eventsList.Add(cs);
                
            }

            foreach (ControllerEventLogs Events in eventsList)
            {
                MergedEvents.MergeEvents(Events);
            }


            return MergedEvents;
        }
        
        /// <summary>
        /// Sorts the detectors by appraoch direction and lane type into the seperate movements.
        /// 
        /// </summary>

        //The basic problem is that each approach (and there are up to 4 of them) can have five types of lanes: right turn, left turn, thru, left thru, right thru.
        //The are bbreviated in the Db as:
        // L1, L2, L3, L4, R1, R2, R3, R4, T1, T2, T3, T4, LT, RT
        private void SortDetectors()
        {
            foreach (MOE.Common.Business.Detector detector in this.Items)
            {

                //Northcound lanes

                //Find everything with and "L" in the lane type field.  If there is no "T" 
                //(which would indicate one of the shared thru lanes), then add it to an approach/movement collection.

                

                    //if (detector.Approach == "Northbound" && (detector.Lane.IndexOf("L") != -1) && (detector.Lane.IndexOf("T") == -1) && (detector.Lane.IndexOf("E") == -1) && (detector.Lane.IndexOf("B") == -1))
                    //{
                    //    NBdetectors.Add(detector);
                    //    NBleftDetectors.Add(detector);
                    //}

                    //if (detector.Approach == "Northbound" && (detector.Lane.IndexOf("R") != -1) && (detector.Lane.IndexOf("T") == -1) && (detector.Lane.IndexOf("E") == -1) && (detector.Lane.IndexOf("B") == -1))
                    //{
                    //    NBdetectors.Add(detector);
                    //    NBrightDetectors.Add(detector);
                    //}

                    //if (detector.Approach == "Northbound" && (detector.Lane.IndexOf("T") != -1) && (detector.Lane.IndexOf("E") == -1) && (detector.Lane.IndexOf("B") == -1))
                    //{
                    //    NBdetectors.Add(detector);
                    //    NBthruDetectors.Add(detector);
                    //}

                    ////Southbound Lanes
                    //if (detector.Approach == "Southbound" && (detector.Lane.IndexOf("L") != -1) && (detector.Lane.IndexOf("T") == -1) && (detector.Lane.IndexOf("E") == -1) && (detector.Lane.IndexOf("B") == -1))
                    //{
                    //    SBdetectors.Add(detector);
                    //    SBleftDetectors.Add(detector);
                    //}

                    //if (detector.Approach == "Southbound" && (detector.Lane.IndexOf("R") != -1) && (detector.Lane.IndexOf("T") == -1) && (detector.Lane.IndexOf("E") == -1) && (detector.Lane.IndexOf("B") == -1))
                    //{
                    //    SBdetectors.Add(detector);
                    //    SBrightDetectors.Add(detector);
                    //}

                    ////Everything with a T in the lane type field is a thru lane, and gets added to that collection.
                    //if (detector.Approach == "Southbound" && (detector.Lane.IndexOf("T") != -1) && (detector.Lane.IndexOf("E") == -1) && (detector.Lane.IndexOf("B") == -1))
                    //{
                    //    SBdetectors.Add(detector);
                    //    SBthruDetectors.Add(detector);
                    //}

                    ////Eastbound Lanes
                    //if (detector.Approach == "Eastbound" && (detector.Lane.IndexOf("L") != -1) && (detector.Lane.IndexOf("T") == -1) && (detector.Lane.IndexOf("E") == -1) && (detector.Lane.IndexOf("B") == -1))
                    //{
                    //    EBdetectors.Add(detector);
                    //    EBleftDetectors.Add(detector);
                    //}

                    //if (detector.Approach == "Eastbound" && (detector.Lane.IndexOf("R") != -1) && (detector.Lane.IndexOf("T") == -1) && (detector.Lane.IndexOf("E") == -1) && (detector.Lane.IndexOf("B") == -1))
                    //{
                    //    EBdetectors.Add(detector);
                    //    EBrightDetectors.Add(detector);
                    //}

                    //if (detector.Approach == "Eastbound" && (detector.Lane.IndexOf("T") != -1) && (detector.Lane.IndexOf("E") == -1) && (detector.Lane.IndexOf("B") == -1))
                    //{
                    //    EBdetectors.Add(detector);
                    //    EBthruDetectors.Add(detector);
                    //}

                    ////Westbound Lanes
                    //if (detector.Approach == "Westbound" && (detector.Lane.IndexOf("L") != -1) && (detector.Lane.IndexOf("T") == -1) && (detector.Lane.IndexOf("E") == -1) && (detector.Lane.IndexOf("B") == -1))
                    //{
                    //    WBdetectors.Add(detector);
                    //    WBleftDetectors.Add(detector);
                    //}

                    //if (detector.Approach == "Westbound" && (detector.Lane.IndexOf("R") != -1) && (detector.Lane.IndexOf("T") == -1) && (detector.Lane.IndexOf("E") == -1) && (detector.Lane.IndexOf("B") == -1))
                    //{
                    //    WBdetectors.Add(detector);
                    //    WBrightDetectors.Add(detector);
                    //}

                    //if (detector.Approach == "Westbound" && (detector.Lane.IndexOf("T") != -1) && (detector.Lane.IndexOf("E") == -1) && (detector.Lane.IndexOf("B") == -1))
                    //{
                    //    WBdetectors.Add(detector);
                    //    WBthruDetectors.Add(detector);
                    //}

                    ////Northbound Exit Lanes

                    //if (detector.Approach == "Northbound" && (detector.Lane.IndexOf("T") != -1) && (detector.Lane.IndexOf("E") != -1) && (detector.Lane.IndexOf("B") == -1))
                    //{
                    //    NBexitDetectors.Add(detector);
                    //}


                    ////Southbound Exit Lanes

                    //if (detector.Approach == "Southbound" && (detector.Lane.IndexOf("T") != -1) && (detector.Lane.IndexOf("E") != -1) && (detector.Lane.IndexOf("B") == -1))
                    //{
                    //    SBexitDetectors.Add(detector);
                    //}

                    ////Eastbound Exit Lanes

                    //if (detector.Approach == "Eastbound" && (detector.Lane.IndexOf("T") != -1) && (detector.Lane.IndexOf("E") != -1) && (detector.Lane.IndexOf("B") == -1))
                    //{
                    //    EBexitDetectors.Add(detector);
                    //}

                    ////Westbound Exit Lanes

                    //if (detector.Approach == "Westbound" && (detector.Lane.IndexOf("T") != -1) && (detector.Lane.IndexOf("E") != -1) && (detector.Lane.IndexOf("B") == -1))
                    //{
                    //    WBexitDetectors.Add(detector);
                    //}

                    ////Northbound Bike

                    //if (detector.Approach == "Northbound" && (detector.Lane.IndexOf("B") > -1) && (detector.Lane.IndexOf("T") > -1))
                    //{
                    //    NBbikedetectors.Add(detector);
                    //    NBThrubikeDetectors.Add(detector);
                    //}

                    //if (detector.Approach == "Northbound" && (detector.Lane.IndexOf("B") > -1) && (detector.Lane.IndexOf("R") > -1))
                    //{
                    //    NBbikedetectors.Add(detector);
                    //    NBRTbikeDetectors.Add(detector);
                    //}

                    //if (detector.Approach == "Northbound" && (detector.Lane.IndexOf("B") > -1) && (detector.Lane.IndexOf("L") > -1))
                    //{
                    //    NBbikedetectors.Add(detector);
                    //    NBLTbikeDetectors.Add(detector);
                    //}


                    ////Southbound Bike

                    //if (detector.Approach == "Southbound" && (detector.Lane.IndexOf("B") > -1) && (detector.Lane.IndexOf("T") > -1))
                    //{
                    //    SBbikedetectors.Add(detector);
                    //    SBThrubikeDetectors.Add(detector);
                    //}

                    //if (detector.Approach == "Southbound" && (detector.Lane.IndexOf("B") > -1) && (detector.Lane.IndexOf("R") > -1))
                    //{
                    //    SBbikedetectors.Add(detector);
                    //    SBRTbikeDetectors.Add(detector);
                    //}

                    //if (detector.Approach == "Southbound" && (detector.Lane.IndexOf("B") > -1) && (detector.Lane.IndexOf("L") > -1))
                    //{
                    //    SBbikedetectors.Add(detector);
                    //    SBLTbikeDetectors.Add(detector);
                    //}


                    ////Eastbound Bike

                    //if (detector.Approach == "Eastbound" && (detector.Lane.IndexOf("B") > -1) && (detector.Lane.IndexOf("T") > -1))
                    //{
                    //    EBbikedetectors.Add(detector);
                    //    EBThrubikeDetectors.Add(detector);
                    //}
                    //if (detector.Approach == "Eastbound" && (detector.Lane.IndexOf("B") > -1) && (detector.Lane.IndexOf("R") > -1))
                    //{
                    //    EBbikedetectors.Add(detector);
                    //    EBRTbikeDetectors.Add(detector);
                    //}
                    //if (detector.Approach == "Eastbound" && (detector.Lane.IndexOf("B") > -1) && (detector.Lane.IndexOf("L") > -1))
                    //{
                    //    EBbikedetectors.Add(detector);
                    //    EBLTbikeDetectors.Add(detector);
                    //}

                    ////Westbound Bike

                    //if (detector.Approach == "Westbound" && (detector.Lane.IndexOf("B") > -1) && (detector.Lane.IndexOf("T") > -1))
                    //{
                    //    WBbikedetectors.Add(detector);
                    //    WBThrubikeDetectors.Add(detector);
                    //}
                    //if (detector.Approach == "Westbound" && (detector.Lane.IndexOf("B") > -1) && (detector.Lane.IndexOf("R") > -1))
                    //{
                    //    WBbikedetectors.Add(detector);
                    //    WBRTbikeDetectors.Add(detector);
                    //}
                    //if (detector.Approach == "Westbound" && (detector.Lane.IndexOf("B") > -1) && (detector.Lane.IndexOf("L") > -1))
                    //{
                    //    WBbikedetectors.Add(detector);
                    //    WBLTbikeDetectors.Add(detector);
                    //}
                

            }

        }
    }
}
